--exec UspImportarArquivoEmpregadores ' 07.924.408/0003-60SULBRAS TRANSPORTADORA LTDA FL 02       27/07/201599.500-000GOVERNADOR LEONEL BRIZOLA BR 386        0     KM 180                                  DISTRITO INDUSTRIAL                     Carazinho                     RS  roberto.rieth@unidasul.com.br                                                                       05134585587            Transporte                    
-- 07.924.408/0004-41SULBRAS TRANSPORTADORA LTDA FL 03       18/11/201597.030-620BR 158 PERIMETRO URBANO                 540                                           PINHEIRO MACHADO                        Santa Maria                   RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Transporte                    
-- 07.924.408/0005-22SULBRAS TRANSPORTADORA LTDA FL 04       20/01/201697.590-000SILVEIRA MARTINS                        2411                                          AREIAS BRANCAS                          Rosario do Sul                RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Transporte                    
-- 07.924.408/0006-03SULBRAS TRANSPORTADORA LTDA FL 05       25/04/201696.050-560VINTE E CINCO DE JULHO                  1447  PAVILHAO D                              FRAGATA                                 Pelotas                       RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Transporte                    
-- 07.924.408/0007-94SULBRAS TRANSPORTADORA LTDA FL 06       25/04/201693.270-010INDEPENDÊNCIA                           9005  PAVILHÃO A1                             NOVO ESTEIO                             Esteio                        RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Transporte                    
-- 07.924.408/0008-75SULBRAS TRANSPORTADORA LTDA FL 07       14/07/201693.270-255LIZANDRO DE ARAUJO FILHO                566   PAVILHÃO G                              NOVO ESTEIO                             Esteio                        RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Transporte                    
-- 07.924.408/0001-07SULBRAS TRANSPORTADORA LTDA MTZ         23/03/200693.270-010INDEPENDÊNCIA                           9005  PAVILHÃO B SALA B3                      NOVO ESTEIO                             Esteio                        RS  roberto.rieth@unidasul.com.br                                                                       05134585500            Transporte                    
-- 07.718.633/0015-84UNIDASUL DIST ALIMENTICIA S.A. FILIAL 0101/12/200590.230-120SAO PEDRO                               512                                           NAVEGANTES                              Porto Alegre                  RS  roberto.rieth@unidasul.com.br                                                                       05133373999            Rissul                        
-- 07.718.633/0022-03UNIDASUL DIST ALIMENTICIA S.A. FILIAL 0201/12/200593.040-193FEITORIA                                350                                           SAO JOSE                                Sao Leopoldo                  RS  roberto.rieth@unidasul.com.br                                                                       05135881780            Rissul                        
-- 07.718.633/0028-07UNIDASUL DIST ALIMENTICIA S.A. FILIAL 0301/12/200593.260-150SOLEDADE                                133                                           CENTRO                                  Esteio                        RS  roberto.rieth@unidasul.com.br                                                                       05134733550            Macromix                      
-- 07.718.633/0034-47UNIDASUL DIST ALIMENTICIA S.A. FILIAL 0601/12/200595.590-000FERNANDES BASTOS                        1527                                          CENTRO                                  Tramandai                     RS  roberto.rieth@unidasul.com.br                                                                       05136612035            Rissul                        
-- 07.718.633/0039-51UNIDASUL DIST ALIMENTICIA S.A. FILIAL 0801/12/200595.600-080JULIO DE CASTILHOS                      2710                                          CENTRO                                  Taquara                       RS  roberto.rieth@unidasul.com.br                                                                       05135424344            Rissul                        
-- 07.718.633/0036-09UNIDASUL DIST ALIMENTICIA S.A. FILIAL 0901/12/200594.920-100JOAO BATISTA S DA S SOUZA               142                                           CENTRO                                  Cachoeirinha                  RS  roberto.rieth@unidasul.com.br                                                                       05134703882            Rissul                        
-- 07.718.633/0040-95UNIDASUL DIST ALIMENTICIA S.A. FILIAL 1301/12/200594.185-452ELY CORREA                              810                                           PARQUE DOS ANJOS                        Gravatai                      RS  roberto.rieth@unidasul.com.br                                                                       05134881292            Rissul                        
-- 07.718.633/0014-01UNIDASUL DIST ALIMENTICIA S.A. FILIAL 1401/12/200592.025-340HUMAITA                                 1400                                          CENTRO                                  Canoas                        RS  roberto.rieth@unidasul.com.br                                                                       05134727505            Rissul                        
-- 07.718.633/0038-70UNIDASUL DIST ALIMENTICIA S.A. FILIAL 1501/12/200595.630-000JOAO MOSMANN                            390                                           CENTRO                                  Parobe                        RS  roberto.rieth@unidasul.com.br                                                                       05135434806            Rissul                        
-- 07.718.633/0043-38UNIDASUL DIST ALIMENTICIA S.A. FILIAL 1601/12/200593.546-000BARTOLOMEU DE GUSMAO                    2185                                          CANUDOS                                 Novo Hamburgo                 RS  roberto.rieth@unidasul.com.br                                                                       05135244669            Rissul                        
-- 07.718.633/0003-40UNIDASUL DIST ALIMENTICIA S.A. FILIAL 1701/12/200593.544-000VEREADOR OSCAR HORN                     1315                                          CANUDOS                                 Novo Hamburgo                 RS  roberto.rieth@unidasul.com.br                                                                       05135952860            Macromix                      
-- 07.718.633/0016-65UNIDASUL DIST ALIMENTICIA S.A. FILIAL 1901/12/200590.560-002CRISTOVAO COLOMBO                       1980                                          FLORESTA                                Porto Alegre                  RS  roberto.rieth@unidasul.com.br                                                                       05133951317            Rissul                        
-- 07.718.633/0027-18UNIDASUL DIST ALIMENTICIA S.A. FILIAL 2101/12/200593.214-170LUCIO BITTENCOURT                       567                                           CENTRO                                  Sapucaia do Sul               RS  roberto.rieth@unidasul.com.br                                                                       05134533744            Rissul                        
-- 07.718.633/0006-93UNIDASUL DIST ALIMENTICIA S.A. FILIAL 2201/12/200593.700-000INDEPENDENCIA                           700   CIDADE SHOPPING                         CENTRO                                  Campo Bom                     RS  roberto.rieth@unidasul.com.br                                                                       05135971667            Rissul                        
-- 07.718.633/0013-12UNIDASUL DIST ALIMENTICIA S.A. FILIAL 2301/12/200592.330-001RIO GRANDE DO SUL                       2560                                          MATHIAS VELHO                           Canoas                        RS  roberto.rieth@unidasul.com.br                                                                       05134781819            Rissul                        
-- 07.718.633/0026-37UNIDASUL DIST ALIMENTICIA S.A. FILIAL 2401/12/200593.125-000PAROBE                                  260                                           SCHARLAU                                Sao Leopoldo                  RS  roberto.rieth@unidasul.com.br                                                                       05135681899            Rissul                        
-- 07.718.633/0033-66UNIDASUL DIST ALIMENTICIA S.A. FILIAL 2501/12/200595.400-000PINHEIRO MACHADO                        40                                            CENTRO                                  Sao Francisco Paula           RS  roberto.rieth@unidasul.com.br                                                                       05432441082            Rissul                        
-- 07.718.633/0007-74UNIDASUL DIST ALIMENTICIA S.A. FILIAL 2601/12/200593.542-150JAMAICA                                 666                                           CANUDOS                                 Novo Hamburgo                 RS  roberto.rieth@unidasul.com.br                                                                       05135954456            Rissul                        
-- 07.718.633/0032-85UNIDASUL DIST ALIMENTICIA S.A. FILIAL 2701/12/200595.680-000JOAO PESSOA                             417                                           CENTRO                                  Canela                        RS  roberto.rieth@unidasul.com.br                                                                       05432821844            Rissul                        
-- 07.718.633/0008-55UNIDASUL DIST ALIMENTICIA S.A. FILIAL 2801/12/200593.800-258VINTE DE SETEMBRO                       3358                                          CENTRO                                  Sapiranga                     RS  roberto.rieth@unidasul.com.br                                                                       05135991470            Rissul                        
-- 07.718.633/0009-36UNIDASUL DIST ALIMENTICIA S.A. FILIAL 2901/12/200593.800-116ANTAO DE FARIAS                         961                                           CENTRO                                  Sapiranga                     RS  roberto.rieth@unidasul.com.br                                                                       05135992597            Macromix                      
-- 07.718.633/0002-60UNIDASUL DIST ALIMENTICIA S.A. FILIAL 3001/12/200593.180-000BRASIL                                  140                                           CENTRO                                  Portao                        RS  roberto.rieth@unidasul.com.br                                                                       05135621733            Rissul                        
-- 07.718.633/0005-02UNIDASUL DIST ALIMENTICIA S.A. FILIAL 3101/12/200593.900-000CORONEL GAELZEL NETO                    64                                            CENTRO                                  Ivoti                         RS  roberto.rieth@unidasul.com.br                                                                       05135631174            Rissul                        
-- 07.718.633/0031-02UNIDASUL DIST ALIMENTICIA S.A. FILIAL 3201/12/200595.670-000BORGES DE MEDEIROS                      3994                                          CENTRO                                  Gramado                       RS  roberto.rieth@unidasul.com.br                                                                       05432864211            Rissul                        
-- 07.718.633/0030-13UNIDASUL DIST ALIMENTICIA S.A. FILIAL 3401/12/200594.410-050CORONEL MARCOS DE ANDRADE               356                                           CENTRO                                  Viamao                        RS  roberto.rieth@unidasul.com.br                                                                       05134851590            Rissul                        
-- 07.718.633/0010-70UNIDASUL DIST ALIMENTICIA S.A. FILIAL 3501/12/200593.315-204NAÇÕES UNIDAS                           334                                           RINCAO                                  Novo Hamburgo                 RS  roberto.rieth@unidasul.com.br                                                                       05135947408            Rissul                        
-- 07.718.633/0021-22UNIDASUL DIST ALIMENTICIA S.A. FILIAL 3601/12/200595.660-000JOAO CORREIA                            275                                           CENTRO                                  Tres Coroas                   RS  roberto.rieth@unidasul.com.br                                                                       05135465420            Rissul                        
-- 07.718.633/0020-41UNIDASUL DIST ALIMENTICIA S.A. FILIAL 3701/12/200595.650-000GENERAL ERNESTO DORNELLES               826                                           CENTRO                                  Igrejinha                     RS  roberto.rieth@unidasul.com.br                                                                       05135453690            Rissul                        
-- 07.718.633/0025-56UNIDASUL DIST ALIMENTICIA S.A. FILIAL 3901/12/200593.270-010INDEPENDENCIA                           9005  PAVLH D                                 NOVO ESTEIO                             Esteio                        RS  roberto.rieth@unidasul.com.br                                                                       05134585551            Indústria                     
-- 07.718.633/0042-57UNIDASUL DIST ALIMENTICIA S.A. FILIAL 4101/12/200593.270-010INDEPENDENCIA                           9005  PAVLH C TERREO                          NOVO ESTEIO                             Esteio                        RS  roberto.rieth@unidasul.com.br                                                                       05134585551            Logística                     
-- 07.718.633/0041-76UNIDASUL DIST ALIMENTICIA S.A. FILIAL 4201/12/200593.125-144THOMAZ EDISON                           2598  PAVILHAO A                              SCHARLAU                                Sao Leopoldo                  RS  roberto.rieth@unidasul.com.br                                                                       05135907200            Macromix                      
-- 07.718.633/0044-19UNIDASUL DIST ALIMENTICIA S.A. FILIAL 4301/08/200693.210-240SAPUCAIA                                720                                           CENTRO                                  Sapucaia do Sul               RS  roberto.rieth@unidasul.com.br                                                                       05134749766            Rissul                        
-- 07.718.633/0050-67UNIDASUL DIST ALIMENTICIA S.A. FILIAL 4601/10/200793.228-080CRUZ ALTA                               183                                           WALDEREZ                                Sapucaia do Sul               RS  roberto.rieth@unidasul.com.br                                                                       05134531227            Rissul                        
-- 07.718.633/0048-42UNIDASUL DIST ALIMENTICIA S.A. FILIAL 4901/10/200794.110-270JORGE AMADO                             523                                           IPIRANGA                                Gravatai                      RS  roberto.rieth@unidasul.com.br                                                                       05134889641            Rissul                        
-- 07.718.633/0049-23UNIDASUL DIST ALIMENTICIA S.A. FILIAL 5001/10/200793.224-000JUSTINO CAMBOIM                         1085                                          LOMBA DA PALMEIRA                       Sapucaia do Sul               RS  roberto.rieth@unidasul.com.br                                                                       05134526400            Rissul                        
-- 07.718.633/0052-29UNIDASUL DIST ALIMENTICIA S.A. FILIAL 5101/10/200795.785-000VINTE CINCO DE JULHO                    83                                            CENTRO                                  HARMONIA                      RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Indústria                     
-- 07.718.633/0053-00UNIDASUL DIST ALIMENTICIA S.A. FILIAL 5201/07/201093.052-270INTEGRAÇÃO                              1383                                          FEITORIA                                Sao Leopoldo                  RS  roberto.rieth@unidasul.com.br                                                                       05135541213            Rissul                        
-- 07.718.633/0055-71UNIDASUL DIST ALIMENTICIA S.A. FILIAL 5416/08/201193.020-668JOÃO CORREA                             1827                                          CENTRO                                  Sao Leopoldo                  RS  roberto.rieth@unidasul.com.br                                                                       05135663388            Macromix                      
-- 07.718.633/0056-52UNIDASUL DIST ALIMENTICIA S.A. FILIAL 5501/07/201095.560-000CASTELO BRANCO                          496                                           IGRA                                    Torres                        RS  roberto.rieth@unidasul.com.br                                                                       05136263843            Macromix                      
-- 07.718.633/0057-33UNIDASUL DIST ALIMENTICIA S.A. FILIAL 5620/11/201292.420-540JUSCELINO KUBITSCHEK DE OLIVEIRA        100   SALA E                                  SAO JOSE                                Canoas                        RS  roberto.rieth@unidasul.com.br                                                                       05134585551            Logística                     
-- 07.718.633/0059-03UNIDASUL DIST ALIMENTICIA S.A. FILIAL 5812/08/201394.035-240CENTENARIO                              555   LJ 327                                  PASSO DAS PEDRAS                        Gravatai                      RS  roberto.rieth@unidasul.com.br                                                                       05134964170            Rissul                        
-- 07.718.633/0060-39UNIDASUL DIST ALIMENTICIA S.A. FILIAL 5910/06/201495.588-000RS 407                                  2575                                          GUARA                                   Xangri-la                     RS  roberto.rieth@unidasul.com.br                                                                       05136895350            Macromix                      
-- 07.718.633/0064-62UNIDASUL DIST ALIMENTICIA S.A. FILIAL 6021/06/201692.020-240LIBERDADE                               1381                                          MARECHAL RONDON                         Canoas                        RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Macromix                      
-- 07.718.633/0061-10UNIDASUL DIST ALIMENTICIA S.A. FILIAL 6214/07/201592.420-540Juscelino Kubitschek de Oliveira        100   Sala G                                  SAO JOSE                                Canoas                        RS  roberto.rieth@unidasul.com.br                                                                       05134585551            Logística                     
-- 07.718.633/0065-43UNIDASUL DIST ALIMENTICIA S.A. FILIAL 6501/08/200692.420-540JUSCELINO KUBITSCHEK DE OLIVEIRA        100   SALA F                                  SAO JOSE                                Canoas                        RS  roberto.rieth@unidasul.com.br                                                                       05134585551            Indústria                     
-- 07.718.633/0067-05UNIDASUL DIST ALIMENTICIA S.A. FILIAL 6704/01/201893.700-000CAIRU                                   125                                           CENTRO                                  Campo Bom                     RS  roberto.rieth@unidasul.com.br                                                                       0513597-4002           Rissul                        
-- 07.718.633/0068-96UNIDASUL DIST ALIMENTICIA S.A. FILIAL 6812/07/201893.270-000INDEPENDENCIA                           9005  PAVILHÃO B. SALA B2                     NOVO ESTEIO                             Esteio                        RS  roberto.rieth@unidasul.com.br                                                                       05134585551            Logística                     
-- 07.718.633/0069-77UNIDASUL DIST ALIMENTICIA S.A. FILIAL 6912/07/201893.270-010Independência                           9005  Pavilhao B sala B1                      NOVO ESTEIO                             Esteio                        RS  roberto.rieth@unidasul.com.br                                                                       05134585551            Logística                     
-- 07.718.633/0070-00UNIDASUL DIST ALIMENTICIA S.A. FILIAL 7001/09/201993.270-255LIZANDRO DE ARAUJO FILHO                566   PAVILHÃO F                              INDUSTRIAL                              Esteio                        RS  roberto.rieth@unidasul.com.br                                                                       05134585551            Manutenção                    
-- 07.718.633/0071-91UNIDASUL DIST ALIMENTICIA S.A. FILIAL 7111/03/202093.270-010INDEPENDENCIA                           9005  PAVILHÃO B SALA B                       NOVO ESTEIO                             Esteio                        RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Atacarejo                     
-- 07.718.633/0072-72UNIDASUL DIST ALIMENTICIA S.A. FILIAL 7215/01/202193.270-010INDEPENDÊNCIA                           9005  PAVILHÃO C 2° ANDAR                     NOVO ESTEIO                             Esteio                        RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Indústria                     
-- 07.718.633/0074-34UNIDASUL DIST ALIMENTICIA S.A. FILIAL 7315/04/202193.270-255LIZANDRO DE ARAUJO FILHO                566   PAVILHÃO E                              INDUSTRIAL                              Esteio                        RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Logística                     
-- 07.718.633/0073-53UNIDASUL DIST ALIMENTICIA S.A. FILIAL 7424/03/202193.224-665CEL. THEODOMIRO P. DA FONSECA           1221                                          PASQUALINI                              Sapucaia do Sul               RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Macromix                      
-- 07.718.633/0075-15UNIDASUL DIST ALIMENTICIA S.A. FILIAL 7511/11/202193.020-174THEODOMIRO PORTO DA FONSECA             2120                                          PADRE REUS                              Sao Leopoldo                  RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Macromix                      
-- 07.718.633/0078-68UNIDASUL DIST ALIMENTICIA S.A. FILIAL 7630/03/202295.590-955CORONEL FERNANDES BASTOS                1777                                          CENTRO                                  Tramandai                     RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Macromix                      
-- 07.718.633/0076-04UNIDASUL DIST ALIMENTICIA S.A. FILIAL 7711/11/202193.180-000RODOVIA RS 240                          3930                                          CENTRO                                  Portao                        RS  roberto.rieth@unidasul.com.br                                                                       05134589070            Macromix                      
-- 07.718.633/0079-49UNIDASUL DIST ALIMENTICIA S.A. FILIAL 7830/03/202292.110-001VENANCIO AIRES                          2800                                          NITEROI                                 Canoas                        RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Rissul                        
-- 07.718.633/0081-63UNIDASUL DIST ALIMENTICIA S.A. FILIAL 7912/07/202293.600-010BRASIL                                  455                                           CENTRO                                  Estancia Velha                RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Rissul                        
-- 07.718.633/0080-82UNIDASUL DIST ALIMENTICIA S.A. FILIAL 8005/05/202295.625-000PARAGUASSU                              4816                                          PRESIDENTE                              Imbe                          RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Macromix                      
-- 07.718.633/0077-87UNIDASUL DIST ALIMENTICIA S.A. FILIAL 8114/01/202293.270-010INDEPENDÊNCIA                           9005  PAVLH C TERREO SALA 01                  NOVO ESTEIO                             Esteio                        RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Indústria                     
-- 07.718.633/0082-44UNIDASUL DIST ALIMENTICIA S.A. FILIAL 8330/08/202293.800-000PRESIDENTE KENNEDY                      1083                                          SAO LUIS                                Sapiranga                     RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Rissul                        
-- 07.718.633/0083-25UNIDASUL DIST ALIMENTICIA S.A. FILIAL 8422/03/202395.600-000OSCAR MARTINS RANGEL                    3464                                          JARDIM DO PRADO                         Taquara                       RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Macromix                      
-- 07.718.633/0001-89UNIDASUL DIST ALIMENTICIA S.A. MTZ      01/01/200693.270-010INDEPENDENCIA                           9005  PAVILHÃO A                              NOVO ESTEIO                             Esteio                        RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Matriz                        '

--exec ImportarArquivoEmpregadores ' 07.924.408/0003-60SULBRAS TRANSPORTADORA LTDA FL 02       27/07/201599.500-000GOVERNADOR LEONEL BRIZOLA BR 386        0     KM 180                                  DISTRITO INDUSTRIAL                     Carazinho                     RS  roberto.rieth@unidasul.com.br                                                                       05134585587            Transporte                    
-- 07.924.408/0004-41SULBRAS TRANSP         LTDA FL 03       18/11/201597.030-620BR 158 PERIMETRO URBANO                 540                                           PINHEIRO MACHADO                        Santa Maria                   RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Transporte                    
-- 07.924.408/0005-22SULBRAS TRANSPORTADORA LTDA FL 04       20/01/201697.590-000SILVEIRA MARTINS                        2411                                          AREIAS BRANCAS                          Rosario do Sul                RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Transporte                    
-- 07.924.408/0006-03SULBRAS TRANSPORTADORA LTDA FL 05       25/04/201696.050-560VINTE E CINCO DE JULHO                  1447  PAVILHAO D                              FRAGATA                                 Pelotas                       RS  roberto.rieth@unidasul.com.br                                                                       05134589700            Transporte                    '

If Exists(Select * From sysobjects Where ID = OBJECT_ID(N'[dbo].[UspImportarArquivoEmpregadores]') And OBJECTPROPERTY(ID, N'IsProcedure') = 1)
	 DROP PROCEDURE [dbo].[UspImportarArquivoEmpregadores]
GO

SET QUOTED_IDENTIFIER OFF
SET ANSI_NULLS ON

GO
 
 CREATE PROCEDURE [dbo].[UspImportarArquivoEmpregadores]
    @Conteudo VARCHAR(MAX)

WITH ENCRYPTION
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SET NOCOUNT ON

DECLARE @DataAtual DATETIME2 = GETDATE()

DECLARE @UltimoIdUnidadeNegocio			INT = (SELECT COALESCE(MAX(ID), 0) AS ULTIMO_ID
                                                 FROM [dbo].[UNIDADES_NEGOCIO])

DECLARE @QuantidadeRegistrosInseridos	INT = 0
DECLARE @QuantidadeRegistrosAtualizados	INT = 0
DECLARE @QuantidadeRegistrosInalterados	INT = 0

-- Variáveis para controle da extração de linhas
DECLARE @Line							VARCHAR(MAX)
DECLARE @StartIndex						INT = 1
DECLARE @EndIndex						INT

-------------------------------------
-- Cria tabela temporária dos CEPS --
-------------------------------------
SELECT TOP 0 * INTO [#TmpCeps] FROM dbo.[CEPS] WITH (NOLOCK)

CREATE INDEX [#TmpCeps] ON [#TmpCeps] ([Cep])

----------------------------------------------------
-- Cria tabela temporária das UNIDADES DE NEGÓCIO --
----------------------------------------------------
SELECT TOP 0 * INTO [#TmpUnidadesNegocio] FROM dbo.[UNIDADES_NEGOCIO] WITH (NOLOCK)

CREATE INDEX [#TmpUnidadesNegocio] ON [#TmpUnidadesNegocio] ([Descricao])

--	Foi necessário popular a Temporária pelo fato da chave de verificação de vínculo não ser o ID e sim a Descrição.
INSERT INTO [#TmpUnidadesNegocio]
     SELECT * FROM dbo.[UNIDADES_NEGOCIO] WITH (NOLOCK)

----------------------------------------
-- Cria tabela temporária das PESSOAS --
----------------------------------------
SELECT TOP 0 * INTO [#TmpPessoas] FROM dbo.[PESSOAS] WITH (NOLOCK)

CREATE INDEX [#TmpPessoas] ON [#TmpPessoas] ([Guid])

--------------------------------------------------
-- Cria tabela temporária das PESSOAS JURÍDICAS --
--------------------------------------------------
SELECT TOP 0 * INTO [#TmpPessoasJuridicas] FROM dbo.[PESSOAS_JURIDICAS] WITH (NOLOCK)

CREATE INDEX [#TmpPessoasJuridicas] ON [#TmpPessoasJuridicas] ([Guid])

-- Loop para processar cada linha da string
WHILE @StartIndex > 0
BEGIN
    -- Encontra o índice da próxima quebra de linha (CRLF)
    SET @EndIndex = CHARINDEX(CHAR(13) + CHAR(10), @Conteudo, @StartIndex);

    -- Se não encontrar uma quebra de linha, usa o restante da string
    IF @EndIndex = 0
    BEGIN
        SET @Line = SUBSTRING(@Conteudo, @StartIndex, LEN(@Conteudo) - @StartIndex + 1);

        SET @StartIndex = 0;  -- Finaliza o loop
    END
    ELSE
    BEGIN
        -- Extrai a linha com base nos índices encontrados
        SET @Line = SUBSTRING(@Conteudo, @StartIndex, @EndIndex - @StartIndex);

        -- Move o índice de início para o próximo caractere após a quebra de linha
        SET @StartIndex = @EndIndex + 2;
    END

	SET @Line = LTRIM(RTRIM(@Line))

	--	CNPJ
	DECLARE @Cnpj AS VARCHAR(18) = SUBSTRING(@Line, 1, 18)
	SET @Cnpj = REPLACE(@Cnpj, '.', '')
	SET @Cnpj = REPLACE(@Cnpj, '/', '')
	SET @Cnpj = REPLACE(@Cnpj, '-', '')

	-- Chave de Exportação e de Importação
	DECLARE @ChaveExportacaoImportacao AS VARCHAR(16) = CONCAT('PJ', @Cnpj)

	--	Razão Social
	DECLARE @RazaoSocial AS VARCHAR(100) = RTRIM(LTRIM(SUBSTRING(@Line, 19, 40)))

	--	Data Fundação
	DECLARE @DataFundacao AS DATE = NULL

	IF ISDATE(SUBSTRING(@Line, 59, 10)) = 1
		SET @DataFundacao = CONVERT(DATE, CAST(SUBSTRING(@Line, 59, 10) AS VARCHAR(10)))

	--	CEP
	DECLARE @Cep AS VARCHAR(10) = RTRIM(LTRIM(SUBSTRING(@Line, 69, 10)))
	SET @Cep = REPLACE(@Cep, '.', '')
	SET @Cep = REPLACE(@Cep, '-', '')

	--	Logradouro
	DECLARE @Logradouro AS VARCHAR(100) = RTRIM(LTRIM(SUBSTRING(@Line, 79, 40)))

	--	Número
	DECLARE @Numero AS VARCHAR(10) = RTRIM(LTRIM(SUBSTRING(@Line, 119, 6)))

	--	Complemento
	DECLARE @Complemento AS VARCHAR(30) = RTRIM(LTRIM(SUBSTRING(@Line, 125, 30)))

	--	Bairro
	DECLARE @Bairro AS VARCHAR(100) = RTRIM(LTRIM(SUBSTRING(@Line, 165, 40)))

	--	Cidade
	DECLARE @Cidade AS VARCHAR(100) = RTRIM(LTRIM(SUBSTRING(@Line, 205, 30)))

	--	UF
	DECLARE @UF AS VARCHAR(2) = SUBSTRING(@Line, 235, 2)

	--	Email
	DECLARE @Email AS VARCHAR(100) = LOWER(RTRIM(LTRIM(SUBSTRING(@Line, 239, 100))))

	--	Telefone
	DECLARE @Telefone AS VARCHAR(30) = RTRIM(LTRIM(SUBSTRING(@Line, 339, 23)))

	--	Unidade de Negócio
	DECLARE @DescricaoUnidadeNegocio AS VARCHAR(30) = UPPER(RTRIM(LTRIM(SUBSTRING(@Line, 362, 30))))

    --	Insere o registro na tabela de CEP, se não existir.
	IF NOT EXISTS(SELECT TOP 1 1 FROM [#TmpCeps] WHERE [CEP] = @Cep)
	BEGIN
		INSERT INTO [#TmpCeps] ([CEP],
								[LOGRADOURO],
								[BAIRRO],
								[CIDADE],
								[UF],
								[DATA_INCLUSAO],
								[DATA_ULTIMA_ALTERACAO])
						VALUES (@Cep,
								@Logradouro,
								@Bairro,
								@Cidade,
								@UF,
								@DataAtual,
								@DataAtual)
	END

	--	Insere o registro na tabela de PESSOA, se não existir.
	DECLARE @GuidPessoa AS UNIQUEIDENTIFIER

	SET @GuidPessoa = (SELECT TOP 1 [GUID]
	                     FROM [#TmpPessoas]
	                    WHERE [CHAVE_EXPORTACAO_IMPORTACAO] = @ChaveExportacaoImportacao)
	IF @GuidPessoa IS NULL
	BEGIN
		SET @GuidPessoa = NEWID()

		INSERT INTO [#TmpPessoas] ([GUID],
								   [CEP],
								   [COMPLEMENTO],
								   [DATA_INCLUSAO],
								   [DATA_ULTIMA_ALTERACAO],
								   [EMAIL],
								   [NUMERO],
								   [TELEFONE],
								   [CHAVE_EXPORTACAO_IMPORTACAO])
						   VALUES (@GuidPessoa,
						           @Cep,
							       @Complemento,
								   @DataAtual,
								   @DataAtual,
								   @Email,
								   @Numero,
								   @Telefone,
								   @ChaveExportacaoImportacao)
	END

	--	Insere o registro na tabela de UNIDADES DE NEGÓCIO, se não existir.
	DECLARE @IdUnidadeNegocio AS INT = (SELECT TOP 1 [ID]
                                          FROM [#TmpUnidadesNegocio]
				                         WHERE [DESCRICAO] = @DescricaoUnidadeNegocio)

	IF @IdUnidadeNegocio IS NULL
	BEGIN
		SET @UltimoIdUnidadeNegocio = @UltimoIdUnidadeNegocio + 1

		SET @IdUnidadeNegocio = @UltimoIdUnidadeNegocio

		INSERT INTO [#TmpUnidadesNegocio] ([ID],
										   [DATA_INCLUSAO],
										   [DATA_ULTIMA_ALTERACAO],
										   [DESCRICAO])
					               VALUES (@IdUnidadeNegocio,
								           @DataAtual,
										   @DataAtual,
										   @DescricaoUnidadeNegocio)
	END

    --	Insere o registro na tabela de PESSOAS JURÍDICAS, se não existir.
	IF NOT EXISTS(SELECT TOP 1 1 FROM [#TmpPessoasJuridicas] WHERE [CNPJ] = @Cnpj)
	BEGIN
		INSERT INTO [#TmpPessoasJuridicas] ([GUID],
			                                [GUIDPESSOA],
				                            [CNPJ],
											[DATA_FUNDACAO],
											[RAZAO_SOCIAL],
											[IDUNIDADE_NEGOCIO])
                                    VALUES (NEWID(),
											@GuidPessoa,
											@Cnpj,
											@DataFundacao,
											@RazaoSocial,
											@IdUnidadeNegocio)
	END
END

--	Atualiza os campos VARCHAR da tabela PESSOAS com NULL se estiverem não preenchidos.
UPDATE T
   SET T.[CEP] = NULL
  FROM [#TmpPessoas] T
 WHERE COALESCE(T.[CEP], '') = ''

UPDATE T
   SET T.[COMPLEMENTO] = NULL
  FROM [#TmpPessoas] T
 WHERE COALESCE(T.[COMPLEMENTO], '') = ''

UPDATE T
   SET T.[EMAIL] = NULL
  FROM [#TmpPessoas] T
 WHERE COALESCE(T.[EMAIL], '') = ''

UPDATE T
   SET T.[NUMERO] = NULL
  FROM [#TmpPessoas] T
 WHERE COALESCE(T.[NUMERO], '') = ''

UPDATE T
   SET T.[TELEFONE] = NULL
  FROM [#TmpPessoas] T
 WHERE COALESCE(T.[TELEFONE], '') = ''

 --select * from [#TmpCeps]
 --select * from [#TmpPessoas]
 --DROP TABLE [#TmpPessoas]
 --DROP TABLE [#TmpCeps]
 --RETURN
 
BEGIN TRANSACTION

--	Atualiza os CEPS que tiveram dados alterados.
    UPDATE C
       SET C.[LOGRADOURO] = T.[LOGRADOURO],
	       C.[BAIRRO] = T.[BAIRRO],
	       C.[CIDADE] = T.[CIDADE],
	       C.[UF] = T.[UF],
		   C.[DATA_ULTIMA_ALTERACAO] = @DataAtual
      FROM [#TmpCeps] T
INNER JOIN [CEPS] C
        ON C.[CEP] = T.[CEP]
	 WHERE C.[LOGRADOURO] <> T.[LOGRADOURO]
	    OR COALESCE(C.[BAIRRO], '') <> COALESCE(T.[BAIRRO], '')
	    OR C.[CIDADE] <> T.[CIDADE]
	    OR C.[UF] <> T.[UF]

IF @@ERROR <> 0
BEGIN
	ROLLBACK TRANSACTION

	GOTO FINALIZA
END

--	Inclui os novos CEPS na tabela.
    INSERT INTO dbo.[CEPS]
         SELECT T.[CEP],
                T.[LOGRADOURO],
			    T.[BAIRRO],
			    T.[CIDADE],
			    T.[UF],
			    T.[DATA_INCLUSAO],
			    T.[DATA_INCLUSAO]
           FROM [#TmpCeps] T
LEFT OUTER JOIN dbo.[CEPS] C WITH (NOLOCK)
             ON C.[CEP] = T.[CEP]
          WHERE C.[CEP] IS NULL

IF @@ERROR <> 0
BEGIN
	ROLLBACK TRANSACTION

	GOTO FINALIZA
END

--	Atualiza as UNIDADES DE NEGÓCIO que tiveram dados alterados.
    UPDATE U
       SET U.[DESCRICAO] = T.[DESCRICAO],
		   U.[DATA_ULTIMA_ALTERACAO] = @DataAtual
      FROM [#TmpUnidadesNegocio] T
INNER JOIN [UNIDADES_NEGOCIO] U
        ON U.[ID] = T.[ID]
	 WHERE U.[DESCRICAO] <> T.[DESCRICAO]

IF @@ERROR <> 0
BEGIN
	ROLLBACK TRANSACTION

	GOTO FINALIZA
END

--	Inclui as novas UNIDADES DE NEGÓCIO na tabela.
    INSERT INTO dbo.[UNIDADES_NEGOCIO]
         SELECT T.[ID],
			    T.[DATA_INCLUSAO],
			    T.[DATA_INCLUSAO],
				T.[DESCRICAO]
           FROM [#TmpUnidadesNegocio] T
LEFT OUTER JOIN dbo.[UNIDADES_NEGOCIO] U WITH (NOLOCK)
             ON U.[ID] = T.[ID]
          WHERE U.[ID] IS NULL

IF @@ERROR <> 0
BEGIN
	ROLLBACK TRANSACTION

	GOTO FINALIZA
END

-- Atualiza a DATA_ULTIMA_ALTERACAO na tabela PESSOAS conforme alterações nos registros da tabela PESSOAS_JURIDICAS.
    UPDATE P
       SET P.[DATA_ULTIMA_ALTERACAO] = @DataAtual
      FROM dbo.[PESSOAS] P
INNER JOIN dbo.[PESSOAS_JURIDICAS] PJ
        ON P.[GUID] = PJ.[GUIDPESSOA]
INNER JOIN [#TmpPessoasJuridicas] T
        ON PJ.[CNPJ] = T.[CNPJ]
     WHERE COALESCE(PJ.[DATA_FUNDACAO], '') <> COALESCE(T.[DATA_FUNDACAO], '')
	    OR COALESCE(PJ.[RAZAO_SOCIAL], '') <> COALESCE(T.[RAZAO_SOCIAL], '')
        OR COALESCE(PJ.[IDUNIDADE_NEGOCIO], '') <> COALESCE(T.[IDUNIDADE_NEGOCIO], '')

IF @@ERROR <> 0
BEGIN
	ROLLBACK TRANSACTION

	GOTO FINALIZA
END

--	Atualiza as PESSOAS que tiveram dados alterados.
    UPDATE P
       SET P.[CEP] = T.[CEP],
           P.[NUMERO] = T.[NUMERO],
		   P.[COMPLEMENTO] = T.[COMPLEMENTO],
	       P.[EMAIL] = T.[EMAIL],
	       P.[TELEFONE] = T.[TELEFONE],
		   P.[DATA_ULTIMA_ALTERACAO] = @DataAtual
      FROM [#TmpPessoas] T
INNER JOIN dbo.[PESSOAS] P
		ON P.[CHAVE_EXPORTACAO_IMPORTACAO] = T.[CHAVE_EXPORTACAO_IMPORTACAO]
     WHERE COALESCE(P.[CEP], '') <> COALESCE(T.[CEP], '')
        OR COALESCE(P.[NUMERO], '') <> COALESCE(T.[NUMERO], '')
	    OR COALESCE(P.[COMPLEMENTO], '') <> COALESCE(T.[COMPLEMENTO], '')
	    OR COALESCE(P.[EMAIL], '') <> COALESCE(T.[EMAIL], '')
	    OR COALESCE(P.[TELEFONE], '') <> COALESCE(T.[TELEFONE], '')

IF @@ERROR <> 0
BEGIN
	ROLLBACK TRANSACTION

	GOTO FINALIZA
END

IF @@ERROR <> 0
BEGIN
	ROLLBACK TRANSACTION

	GOTO FINALIZA
END

--	Inclui as novas PESSOAS na tabela.
    INSERT INTO dbo.[PESSOAS]
         SELECT T.[GUID],
		        T.[CEP],
                T.[COMPLEMENTO],
			    T.[DATA_INCLUSAO],
			    T.[DATA_INCLUSAO],
			    T.[EMAIL],
				T.[NUMERO],
			    T.[TELEFONE],
				T.[CHAVE_EXPORTACAO_IMPORTACAO]
           FROM [#TmpPessoas] T
LEFT OUTER JOIN dbo.[PESSOAS] P WITH (NOLOCK)
             ON P.[CHAVE_EXPORTACAO_IMPORTACAO] = T.[CHAVE_EXPORTACAO_IMPORTACAO]
          WHERE P.[GUID] IS NULL

IF @@ERROR <> 0
BEGIN
	ROLLBACK TRANSACTION

	GOTO FINALIZA
END

--	Atualiza as PESSOAS JURÍDICAS que tiveram dados alterados.
    UPDATE P
       SET P.[DATA_FUNDACAO] = T.[DATA_FUNDACAO],
           P.[RAZAO_SOCIAL] = T.[RAZAO_SOCIAL],
		   P.[IDUNIDADE_NEGOCIO] = T.[IDUNIDADE_NEGOCIO]
      FROM [#TmpPessoasJuridicas] T
INNER JOIN dbo.[PESSOAS_JURIDICAS] P
        ON P.[CNPJ] = T.[CNPJ]
	 WHERE COALESCE(P.[DATA_FUNDACAO], '') <> COALESCE(T.[DATA_FUNDACAO], '')
	    OR P.[RAZAO_SOCIAL] <> T.[RAZAO_SOCIAL]
	    OR P.[IDUNIDADE_NEGOCIO] <> T.[IDUNIDADE_NEGOCIO]

IF @@ERROR <> 0
BEGIN
	ROLLBACK TRANSACTION

	GOTO FINALIZA
END

--	Inclui as novas PESSOAS JURÍDICAS na tabela.
    INSERT INTO dbo.[PESSOAS_JURIDICAS]
         SELECT T.[GUID],
		        T.[GUIDPESSOA],
		        T.[CNPJ],
			    T.[DATA_FUNDACAO],
				T.[LOGOTIPO],
			    T.[RAZAO_SOCIAL],
				T.[IDUNIDADE_NEGOCIO]
           FROM [#TmpPessoasJuridicas] T
LEFT OUTER JOIN dbo.[PESSOAS_JURIDICAS] P WITH (NOLOCK)
             ON P.[CNPJ] = T.[CNPJ]
          WHERE P.[GUID] IS NULL

IF @@ERROR <> 0
BEGIN
	ROLLBACK TRANSACTION

	GOTO FINALIZA
END

COMMIT TRANSACTION

--	Contabiliza os registros atualizados.
SET @QuantidadeRegistrosAtualizados = (    SELECT COUNT(*)
                                             FROM dbo.[PESSOAS_JURIDICAS] PJ
                                       INNER JOIN dbo.[PESSOAS] P
									           ON PJ.[GUIDPESSOA] = P.[GUID]
                                            WHERE P.[DATA_INCLUSAO] <> P.[DATA_ULTIMA_ALTERACAO]
											  AND P.[DATA_ULTIMA_ALTERACAO] = @DataAtual )

--	Contabiliza os registros que não sofreram nenhum tipo de modificação.
SET @QuantidadeRegistrosInalterados = (    SELECT COUNT(*)
                                             FROM dbo.[PESSOAS_JURIDICAS] PJ
                                       INNER JOIN dbo.[PESSOAS] P
								               ON PJ.[GUIDPESSOA] = P.[GUID]
                                            WHERE P.[DATA_ULTIMA_ALTERACAO] < @DataAtual )

--	Contabiliza os registros inseridos.
SET @QuantidadeRegistrosInseridos = (    SELECT COUNT(*)
                                           FROM dbo.[PESSOAS_JURIDICAS] PJ
                                     INNER JOIN dbo.[PESSOAS] P
								             ON PJ.[GUIDPESSOA] = P.[GUID]
                                          WHERE P.[DATA_INCLUSAO] = P.[DATA_ULTIMA_ALTERACAO]
									        AND P.[DATA_INCLUSAO] = @DataAtual )

SELECT @DataAtual AS 'DATA_INICIO',
       GETDATE() AS 'DATA_FIM',
       @QuantidadeRegistrosAtualizados AS 'QUANTIDADE_REGISTROS_ATUALIZADOS',
       @QuantidadeRegistrosInalterados AS 'QUANTIDADE_REGISTROS_INALTERADOS',
	   @QuantidadeRegistrosInseridos   AS 'QUANTIDADE_REGISTROS_INSERIDOS'

FINALIZA:

DROP TABLE [#TmpPessoasJuridicas]

DROP TABLE [#TmpPessoas]

DROP TABLE [#TmpUnidadesNegocio]

DROP TABLE [#TmpCeps]

GO

--DELETE FROM PESSOAS_FISICAS
--DELETE FROM PESSOAS_JURIDICAS
--DELETE FROM PESSOAS